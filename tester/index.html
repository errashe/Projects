<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Test example</title>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css">
	<style>
		html, body { height: 100%; background-color: gray; }
		.main { margin-top: 48px; padding: 50px; }
		.text { padding: 20px; }
		.unselectable {
			-webkit-touch-callout: none;
			-webkit-user-select: none;
			-hktml-user-select: none;
			-moz-user-select: none;
			-ms-user-select: none;
			user-select: none;
		}
		.omg {
			position: absolute;
			left: 0px;
			top: 0px;
			background-color: white;
			width: 100%;
			height: 100%;
			z-index: 1000;
		}
	</style>
	<script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/countdown/2.6.0/countdown.min.js"></script>
	<script type="text/javascript">
		$(document).ready(function() {
			var clog = console.log;
			$.fn.randomize = function() {
				var allElems = this.get(),
				getRandom = function(max) {
					return Math.floor(Math.random() * max);
				},
				shuffled = $.map(allElems, function() {
					var random = getRandom(allElems.length),
					randEl = $(allElems[random]).clone(true)[0];
					allElems.splice(random, 1);
					return randEl;
				});

				this.each(function(i) {
					$(this).replaceWith($(shuffled[i]));
				});

				return $(shuffled);
			}

			function renderQuestion() {
				$.ajax("/question").done(function(msg) {
					$("div.text").html(msg.Text);
					$("div.text").attr("_id", msg.id);

					$("div.question div.answers").empty();

					$.each(msg.Variances, function(key, value) {
						var input = document.createElement("div");
						input.setAttribute("name", "answer");
						input.setAttribute("key", key);
						input.innerText = value;
						input.classList.add("unselectable");
						input.classList.add("alert");
						input.classList.add("alert-warning");
						input.style = "padding: 5px; margin: 5px;"
						$("div.question div.answers").append(input);
					});

					$("div.question div.answers div[name=answer]").randomize();

					$("div[name=answer]").click(function(e) {
						if (e.target.classList.contains("alert-info")) {
							e.target.classList.remove("alert-info");
							e.target.classList.add("alert-warning");
						} else {
							e.target.classList.add("alert-info");
							e.target.classList.remove("alert-warning");
						}
					});
				});
			}

			$("div.send-answers").click(function(e) {
				var answers = $("div.alert-info");
				answers = $.map(answers, function(val, i) {
					return $(val).attr("key");
				});

				// clog(answers);
				$.ajax("/answer", {method: "POST", data: {
					id: $("div.text").attr("_id"),
					variance: JSON.stringify(answers)
				}}).done(function(msg) {
					var intervals = [];
					$.each(msg.ranswers, function(i, ans) {
						var was = $(`div[key=${ans}`).hasClass("alert-warning") ? "alert-warning" : "alert-info";
						var i = setInterval(function() {
							if ($(`div[key=${ans}`).hasClass("alert-success")) {
								$(`div[key=${ans}`).addClass(was);
								$(`div[key=${ans}`).removeClass("alert-success");
							} else {
								$(`div[key=${ans}`).removeClass(was);
								$(`div[key=${ans}`).addClass("alert-success");
							}
						}, 300);
						intervals.push(i);
					});
					setTimeout(function() {
						$.map(intervals, clearInterval);
						renderProfile();
						renderQuestion();
					}, 5000);
				});
			});

			function renderProfile() {
				$.ajax("/user").done(function(msg) {
					if(msg.message != "ERROR") {
						$("form").hide();
						$("[name=profile]").show();
						$("a[name=username]").text(msg.Username);
						var percentage = 100*msg.Ranswers/msg.Answers || 0;
						// clog(percentage);
						$(".success-p").css("width", `${percentage}%`);
						$(".success-p-text").text(`${msg.Ranswers} of ${msg.Answers} and ${(100*msg.Ranswers/msg.Answers).toFixed(2)}% correct`)
					} else {
						$("[name=profile]").hide();
						$("form").show();
						$(".success-p").css("width", "50%");
						$(".success-p-text").text(`0 of 0 correct (cuz u unregistered)`)
					}
				});
			}

			$("form").submit(function(e) {
				e.preventDefault();
				var username = $("input[name=username]").val();
				var password = $("input[name=password]").val();

				$.ajax("/login", {method: "POST", crossDomain: true,
					data: { username: username, password: password }
				}).done(function(msg) {
					// clog(msg);
					renderProfile();
				});
				$(this).trigger("reset");
			});

			$("a[href='/user'").click(function(e) {
				e.preventDefault();
				$.ajax("/user").done(function(msg) { clog(msg); });
			});

			$("a[href='/logout']").click(function(e) {
				e.preventDefault();
				$.ajax("/logout", { method: "POST", crossDomain: true}).done(function(msg) {
					renderProfile();
				});
			});

			renderProfile();
			renderQuestion();

			setInterval(function() {
				$(".date_to_exam").text(`${countdown( new Date(), new Date(2016, 11, 17, 8, 0, 0) ).toString()} until exam`);
			}, 1000);
		});
	</script>
</head>
<body>
	<nav class="navbar navbar-inverse navbar-fixed">
		<div class="container">
			<div class="navbar-header">
				<a href="#" class="navbar-brand">Tester</a>
			</div>
			<div class="navbar-collapse collapse">
				<ul class="nav navbar-nav navbar-right" name="profile" style="display: none;">
					<li><a href="/user" name="username">22</a></li>
					<li><a href="/logout">Logout</a></li>
				</ul>
				<form action="/auth" method="POST" class="navbar-form navbar-right">
					<div class="form-group"><input type="text" name="username" class="form-control"></div>
					<div class="form-group"><input type="password" name="password" class="form-control"></div>
					<button type="submit" class="btn btn-default">Sign in</button>
				</form>
			</div>
		</div>
	</nav>

	<div class="main">
		<div class="container">
			<div class="panel panel-default">
				<div class="panel-body">
					<div class="date_to_exam text-center" style="font-size: 20px;"></div>
				</div>
			</div>

			<div class="panel panel-default">
				<div class="progress" style="margin-bottom: 0px;">
					<div class="success-p progress-bar progress-bar-success" role="progressbar">
						<span class="sr-only">Complete</span>
					</div>
				</div>
				<div class="panel-body success-p-text text-center" style="font-size: 20px; background-color: lightgray;"></div>
			</div>

			<div class="question">
				<div class="panel panel-default">
					<div class="panel-heading text" style="font-size: 16px;"></div>
					<div class="panel-body" style="text-align: center; background-color: lightgray;">
						<div class="answers" style="float: left; width: 79%;"></div>
						<div class="send-answers unselectable alert alert-success" style="float: right; width: 19%; height: 100%;">send</div>
					</div>
				</div>
			</div>

			<div class="alerts"></div>
		</div>
	</div>
</body>
</html>