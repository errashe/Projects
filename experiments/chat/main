#!/usr/bin/env ruby

require 'sinatra'
require 'sinatra-websocket'

require 'json'

def rand_nick
	(0...10).map { ('a'..'z').to_a[rand(26)] }.join
end

set :server, :thin

set :sessions, :enable
set :session_secret, '*&(^B234'

# set :bind, '192.168.1.140' # Здесь внешний адрес
# set :port, '80'
# set :environment, :production

set :sockets, []

get '/' do
	if !request.websocket?
		session[:nick] ||= rand_nick
		erb :index
	else
		request.websocket do |ws|
			ws.onopen do
				settings.sockets << ws
			end
			ws.onmessage do |msg|
				settings.sockets.each{|s| s.send([session[:nick], msg].to_json) }
			end
			ws.onclose do
				settings.sockets.delete(ws)
			end
		end
	end
end
