#!/usr/bin/env ruby
require 'sinatra'
require 'data_mapper'
require 'dm-migrations' if development?

DataMapper.setup(:default, "sqlite3://#{Dir.pwd}/dev.db")

class Message
	include DataMapper::Resource

	property :id, Serial
	property :message, Text

	before :save do |msg|
		Sinatra::Application.settings.connections.each { |out| out << "data: #{msg[:message]}\n\n" }
	end
end

DataMapper.finalize
DataMapper.auto_upgrade! if development?

set :server, :thin
set :connections, []

set :sessions, :enable
set :session_secret, 'super secret'

helpers do
	def user; session[:user]; end
end

get '/' do
	halt erb(:login) unless !user.nil?
	@messages = Message.all(:limit => 5, :order => [:id.desc])
	erb :chat
end

post '/login' do
	session[:user] ||= params[:user]
	redirect to("/")
end

get '/stream', provides: 'text/event-stream' do
	stream :keep_open do |out|
		settings.connections << out
		out.callback { settings.connections.delete(out) }
	end
end

post '/' do
	Message.create(:message => params[:msg])
	204
end

__END__

@@ layout
<html>
<head>
	<title>Super Simple Chat with Sinatra</title>
	<meta charset="utf-8" />
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
</head>
<body><%= yield %></body>
</html>

@@ login
<form action='/login' method='post'>
	<label for='user'>User Name:</label>
	<input name='user' value='' />
	<input type='submit' value="GO!" />
</form>

@@ chat
<div id='chat'>
	<% @messages.each do |msg| %>
		<%= "#{msg[:message]}" %><br />
	<% end %>
</div>

<form>
	<input id='msg' placeholder='type message here...' />
</form>

<script>
	// reading
	var es = new EventSource('/stream');
	es.onmessage = function(e) { $('#chat').prepend(e.data + `<br />`) };
	// writing
	$("form").on("submit", function(e) {
		e.preventDefault();
		$.post('/', {msg: "<%= user %>: " + $('#msg').val()});
		$('#msg').val(''); $('#msg').focus();
	});
</script>
